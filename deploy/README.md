# ๐ฆ ุฑุงูููุง ุงุณุชูุฑุงุฑ ูพุฑูฺู EazyMenu

ุงู ุณูุฏ ูุฑุงุญู ุขูุงุฏูโุณุงุฒ ุณุฑูุฑ ู ุงุณุชูุฑุงุฑ ุณุฑูุณโูุง EazyMenu ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ ุงุณฺฉุฑูพุช `provision-ubuntu.sh` ู Docker Compose ุชูุถุญ ูโุฏูุฏ. ุชูุงู ุชูุถุญุงุช ุจูโุตูุฑุช ฺฏุงูโุจูโฺฏุงู ุงุฑุงุฆู ุดุฏู ุชุง ุจุชูุงูุฏ ุณุฑูุณ ุฑุง ุฑู ุณุฑูุฑ ุชุงุฒู ูุตุจโุดุฏู ุงูุจููุชู ุฑุงูโุงูุฏุงุฒ ฺฉูุฏ.

## 1. ูพุดโูุงุฒูุง

- **ุณุณุชูโุนุงูู:** Ubuntu 22.04 LTS (ุง ูุณุฎู ุฌุฏุฏุชุฑ ุณุงุฒฺฏุงุฑ)
- **ุฏุณุชุฑุณ ฺฉุงุฑุจุฑ:** ุฏุณุชุฑุณ `root` ุง ฺฉุงุฑุจุฑ ุฏุงุฑุง ูุฌูุฒ `sudo`
- **ุฏุงููู:** ุฑฺฉูุฑุฏ A/AAAA ูุนุงู ุจุฑุง ุฏุงูููโุง ฺฉู ุจุง EazyMenu ุงุณุชูุงุฏู ูโฺฉูุฏ (ุฏุฑ ุตูุฑุช ูุนุงูโุณุงุฒ TLS)
- **ูพูุฑุชโูุง ุจุงุฒ:**
  - 22 (SSH)
  - 80 (HTTP)
  - 443 (HTTPS)
  - 5000 (ูพูุฑุช ุฏุงุฎู ูพุดโูุฑุถ ุจุฑูุงูู โ ูุงุจู ุชุบุฑ ุจุง ูุชุบุฑ ูุญุท)
- **ูุตุจ ูุจูุฏู ูพฺฉุฌโูุง Docker:** ุงฺฏุฑ Docker ุงุฒ ูุจู ูุตุจ ุดุฏู ุงุณุชุ ุงุจุชุฏุง ูุณุฎูโูุง ูุฏู ุฑุง ุญุฐู ุง ุจูโุฑูุฒุฑุณุงู ฺฉูุฏ.

## 2. ูุชุบุฑูุง ูุญุท ุถุฑูุฑ

ูพุด ุงุฒ ุงุฌุฑุง ุงุณฺฉุฑูพุชุ ูุชุบุฑูุง ุฒุฑ ุฑุง ุฏุฑ ูุญุท ุดู ุชูุธู ฺฉูุฏ:

```bash
export EAZY_SQL_SA_PASSWORD="ูพุณูุฑุฏ_ูู_ุจุฑุง_SA"
export EAZY_SQL_APP_PASSWORD="ูพุณูุฑุฏ_ูู_ุจุฑุง_ฺฉุงุฑุจุฑ_ุจุฑูุงูู"
```

ูุชุบุฑูุง ุงุฎุชุงุฑ ููู:

| ูุชุบุฑ | ููุฏุงุฑ ูพุดโูุฑุถ | ุชูุถุญ |
| --- | --- | --- |
| `EAZY_APP_USER` | `eazymenu` | ูุงู ฺฉุงุฑุจุฑ ุณุณุชู ฺฉู ุณุฑูุณโูุง ุฒุฑ ุขู ุงุฌุฑุง ูโุดููุฏ |
| `EAZY_APP_ROOT` | `/opt/eazymenu` | ูุณุฑ ูุตุจ ูพุฑูฺู |
| `EAZY_GIT_REPO` | `https://github.com/Merkousha/EazyMeny-Main.git` | ุขุฏุฑุณ ูุฎุฒู ฺฏุช |
| `EAZY_GIT_BRANCH` | (ุชุดุฎุต ุฎูุฏฺฉุงุฑ) | ุดุงุฎู ููุฑุฏ ุงุณุชูุงุฏูุ ุฏุฑ ุตูุฑุช ูุงุฒ ููุฏุงุฑุฏู ฺฉูุฏ |
| `EAZY_ENVIRONMENT` | `Production` | ููุฏุงุฑ `ASPNETCORE_ENVIRONMENT` |
| `EAZY_WEB_INTERNAL_PORT` | `5000` | ูพูุฑุช ฺฉู Nginx ุจู ุขู ูพุฑุงฺฉุณ ูโฺฉูุฏ |
| `EAZY_ENABLE_TLS` | `true` | ูุนุงูโุณุงุฒ TLS ู ุฏุฑุงูุช ฺฏูุงู Letโs Encrypt |
| `EAZY_WEB_DOMAIN` | โ | ูุงู ุฏุงูููุ ุฏุฑ ุตูุฑุช ูุนุงู ุจูุฏู TLS ุงูุฒุงู ุงุณุช |
| `EAZY_CERTBOT_EMAIL` | โ | ุงูู ูุนุชุจุฑ ุจุฑุง Letโs Encrypt |
| `EAZY_SQL_CONTAINER_NAME` | `eazymenu-sql` | ูุงู ฺฉุงูุชูุฑ SQL Server |
| `EAZY_SQL_DB_NAME` | `EazyMenuDb` | ูุงู ูพุงฺฏุงูโุฏุงุฏู ุงุตู |
| `EAZY_SQL_APP_USER` | `eazymenu_app` | ฺฉุงุฑุจุฑ ุจุฑูุงูู ุฏุฑ SQL |

> **ูฺฉุชู ุงููุช:** ุงุฒ ูุฑุงุฑ ุฏุงุฏู ููุงุฏุฑ ุฑูุฒ ุฏุฑ ุชุงุฑุฎฺู ุดู ุฎูุฏุฏุงุฑ ฺฉูุฏุ ุฏุฑ ุตูุฑุช ูุงุฒ ุงุฒ ูุงูโูุง ูุญุท ูููุช ุง `systemd drop-in` ุงุณุชูุงุฏู ฺฉูุฏ.

## 3. ุงุฌุฑุง ุงุณฺฉุฑูพุช ุชุฏุงุฑฺฉ ุณุฑูุฑ

1. ฺฉููู ุง ุฏุงูููุฏ ูุฎุฒู ุฑู ุณุฑูุฑ:
   ```bash
   git clone https://github.com/Merkousha/EazyMeny-Main.git
   cd EazyMeny-Main/deploy
   ```
2. ุชูุธู ูุชุบุฑูุง ูุญุท (ุจุฎุด ูุจู).
3. ุงุฌุฑุง ุงุณฺฉุฑูพุช ุจุง ุฏุณุชุฑุณ ุฑุดู:
   ```bash
   sudo -E ./provision-ubuntu.sh
   ```
   - ฺฏุฒูู `-E` ูุชุบุฑูุง ูุญุท ูุนู ุฑุง ุญูุธ ูโฺฉูุฏ.
   - ุงุณฺฉุฑูพุช ุจู ุชุฑุชุจ ูุฑุงุญู ุฒุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ:
     - ุจูโุฑูุฒุฑุณุงู ุณุณุชูโุนุงูู ู ูุตุจ ุจุณุชูโูุง ูพุงู (Docker, Nginx, Certbot ู ...)
     - ุณุงุฎุช ฺฉุงุฑุจุฑ ุณุณุชู ุงุฎุชุตุงุต ู ุฏุงุฑฺฉุชูุฑโูุง `/opt/eazymenu`
     - ฺฉููู/ุจุฑูุฒุฑุณุงู ูุฎุฒู ุจุง ุดุงุฎู ูุดุฎุต ุดุฏู
     - ุชููุฏ ูุงู `.env` ุจุฑุง Docker Compose ู ุซุจุช ุงุณููพโุดุงุช ุชูุธูุงุช ุฏุฑ `/etc/eazymenu/runtime.env`
     - ุฑุงูโุงูุฏุงุฒ SQL Server ู ุงุฌุงุฏ ุฏุชุงุจุณ + ฺฉุงุฑุจุฑ ุจุฑูุงูู
     - ุงุฌุฑุง ูุงฺฏุฑุดูโูุง EF Core ุงุฒ ฺฉุงูุชูุฑ `migrator`
     - ุจูุฏ ู ุงุฌุฑุง ฺฉุงูุชูุฑ `eazymenu-web`
     - ุชูุธู Nginx ู ุฏุฑ ุตูุฑุช ูุงุฒ ุฏุฑุงูุช ฺฏูุงู TLS
     - ูุนุงูโุณุงุฒ Fail2ban ุจุฑุง ูุญุงูุธุช SSH

ูพุณ ุงุฒ ุงุชูุงู ููููุ ุณุฑูุณ ุงุฒ ุทุฑู `http(s)://<ุฏุงููู>` ุฏุฑ ุฏุณุชุฑุณ ุฎูุงูุฏ ุจูุฏ.

## 4. ุณุงุฎุชุงุฑ Docker Compose

ูุงู `deploy/docker/docker-compose.yml` ุณู ุณุฑูุณ ุงุฌุงุฏ ูโฺฉูุฏ:

- **sqlserver:** ุฏุชุงุจุณ SQL Server 2022 ุจุง ูููู ุฏุงุฆู
- **eazymenu-web:** ุจุฑูุงูู ASP.NET Core (ูพูุฑุช ุฏุงุฎู 8080ุ ุจูโุตูุฑุช ูพุดโูุฑุถ ุจุง Nginx ุฑู 80/443 ููุชุดุฑ ูโุดูุฏ)
- **migrator:** ฺฉุงูุชูุฑ ูููุช ุฌูุช ุงุฌุฑุง ุฏุณุชูุฑุงุช EF Core (ุฏุฑ ุฒูุงู provisioning ู ููฺฏุงู ูุงุฒ ุจู ูุงฺฏุฑุดู ุฌุฏุฏ)

ูุงู `.env` ุชููุฏุดุฏู ุดุงูู ุงุทูุงุนุงุช ุงุชุตุงูุ ูุงู ฺฉุงูุชูุฑูุงุ ูุณุฑูุง ู ูพูุฑุชโูุงุณุช. ุงุฒ ูุฑุงุด ุฏุณุช ูุงู ุฌุฒ ุฏุฑ ููุงุฑุฏ ุถุฑูุฑ ุฎูุฏุฏุงุฑ ฺฉูุฏ.

## 5. ุนููุงุช ูฺฏูโุฏุงุฑ ู ุจูโุฑูุฒุฑุณุงู

### 5.1 ุจูโุฑูุฒุฑุณุงู ูุณุฎู ุจุฑูุงูู

```bash
sudo -u eazymenu -H git -C /opt/eazymenu/src pull --ff-only
sudo -u eazymenu -H docker compose -f /opt/eazymenu/src/deploy/docker/docker-compose.yml --env-file /opt/eazymenu/src/deploy/docker/.env build eazymenu-web
sudo -u eazymenu -H docker compose -f /opt/eazymenu/src/deploy/docker/docker-compose.yml --env-file /opt/eazymenu/src/deploy/docker/.env up -d eazymenu-web
```

### 5.2 ุงุฌุฑุง ูุฌุฏุฏ ูุงฺฏุฑุดูโูุง

```bash
sudo -u eazymenu -H docker compose -f /opt/eazymenu/src/deploy/docker/docker-compose.yml --env-file /opt/eazymenu/src/deploy/docker/.env run --rm migrator
```

### 5.3 ูุดุงูุฏู ูุงฺฏโูุง

- ูุงฺฏ ุจุฑูุงูู: `/var/log/eazymenu/app` (ุฏุฑ ุตูุฑุช Bind-Mount ุขูุฏู)
- ูุงฺฏ Nginx: `/var/log/eazymenu/nginx`
- ูุงฺฏ ฺฉุงูุชูุฑูุง:
  ```bash
  sudo -u eazymenu -H docker compose -f /opt/eazymenu/src/deploy/docker/docker-compose.yml logs -f
  ```

### 5.4 ุชูุฏุฏ ฺฏูุงู TLS

Certbot ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุงุฒ ุทุฑู `systemd timer` ุชูุฏุฏ ุฑุง ุงูุฌุงู ูโุฏูุฏ. ุจุฑุง ุงุฌุฑุง ุฏุณุช:

```bash
sudo certbot renew --dry-run
```

## 6. ุนุจโุงุจ ูุชุฏุงูู

| ูุดฺฉู | ุฑุงูโุญู ูพุดููุงุฏ |
| --- | --- |
| ุนุฏู ุงุชุตุงู ุจู SQL Server ูพุณ ุงุฒ ุจุงุฑฺฏุฐุงุฑ | ุฑูุฒ `SA` ุฐุฎุฑูโุดุฏู ุฏุฑ ูููู ุจุง ููุฏุงุฑ ุฌุฏุฏ ูุชูุงูุช ุงุณุชุ ฺฉุงูุชูุฑ ู ูููู ุฑุง ุญุฐู ฺฉูุฏ ุง ุฑูุฒ ุตุญุญ ุฑุง ุชูุธู ฺฉูุฏ. |
| ุฎุทุง ุฏุฑุงูุช ฺฏูุงู ุงุฒ Letโs Encrypt | ุงุฒ ุชูุธู ุจูุฏู DNS ู ุจุงุฒ ุจูุฏู ูพูุฑุช 80 ุงุทููุงู ุญุงุตู ฺฉูุฏ. |
| ุฎุทุง `permission denied` ุฏุฑ ุงุฌุฑุง Docker | ุจุฑุฑุณ ฺฉูุฏ ฺฉุงุฑุจุฑ `eazymenu` ุฏุฑ ฺฏุฑูู `docker` ูุฑุงุฑ ฺฏุฑูุชู ุจุงุดุฏ (`sudo usermod -aG docker eazymenu` ู ุณูพุณ ุฎุฑูุฌ/ูุฑูุฏ ูุฌุฏุฏ). |
| ุชููู ุจุฑูุงูู ูพุณ ุงุฒ ุฑุจูุช | ุฏุณุชูุฑ `docker compose up -d` ุฑุง ุงุฌุฑุง ฺฉูุฏ ุง ฺฉ ุณุฑูุณ systemd ุจุฑุง ุงุฌุฑุง ุฎูุฏฺฉุงุฑ ุงุถุงูู ฺฉูุฏ. |

## 7. ูพุงฺฉโุณุงุฒ ุง ุญุฐู ุณุฑูุณโูุง

```bash
sudo -u eazymenu -H docker compose -f /opt/eazymenu/src/deploy/docker/docker-compose.yml --env-file /opt/eazymenu/src/deploy/docker/.env down
sudo docker volume rm eazymenu-sql-data   # ุฏุฑ ุตูุฑุช ุญุฐู ฺฉุงูู ุฏุงุฏูโูุง
sudo rm -rf /opt/eazymenu
sudo rm -rf /var/log/eazymenu /etc/eazymenu
```

> **ูุดุฏุงุฑ:** ุญุฐู ูููู `eazymenu-sql-data` ุชูุงู ุฏุงุฏูโูุง ูพุงฺฏุงูโุฏุงุฏู ุฑุง ุงุฒ ุจู ูโุจุฑุฏ. ูุจู ุงุฒ ุงุฌุฑุง ุงุฒ ูพุดุชุจุงูโฺฏุฑ ุงุทููุงู ุญุงุตู ฺฉูุฏ.

---

ุจุง ูพุฑู ุงุฒ ุงู ูุฑุงุญู ูโุชูุงูุฏ ุงุณุชูุฑุงุฑ EazyMenu ุฑุง ุฑู ุณุฑูุฑ ุฌุฏุฏ ุจูโุณุฑุนุช ุงูุฌุงู ุฏูุฏ. ุฏุฑ ุตูุฑุช ูุงุฒ ุจู ุณูุงุฑููุง ูพฺุฏูโุชุฑ (ูุงููุฏ ุฎูุดูโุจูุฏ ุง ูุงูุชูุฑูฺฏ) ูโุชูุงูุฏ ุจุฎุดโูุง ูุฑุชุจุท ุฑุง ุฏุฑ ุงุณฺฉุฑูพุช ุง Compose ุณูุงุฑุดโุณุงุฒ ฺฉูุฏ.
