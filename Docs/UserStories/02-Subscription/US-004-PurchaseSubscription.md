# User Story 04: انتخاب و خرید اشتراک

## شناسه: US-004
**اولویت:** بالا  
**فاز:** MVP  
**تخمین زمان:** 3 روز

---

## شرح User Story

**به عنوان یک** مدیر رستوران  
**می‌خواهم** پلن اشتراک مناسب برای رستوران خود را انتخاب و خریداری کنم  
**تا بتوانم** از خدمات پلتفرم بر اساس نیازهای کسب‌وکارم استفاده کنم.

---

## معیارهای پذیرش (Acceptance Criteria)

### سناریو 1: مشاهده پلن‌های اشتراک
**Given:** کاربر ثبت‌نام کرده و به صفحه انتخاب پلن هدایت شده است  
**When:** صفحه انتخاب پلن را مشاهده می‌کند  
**Then:**
- تمام پلن‌های موجود نمایش داده می‌شود:
  - **Basic:** 500,000 تومان/ماه
  - **Standard:** 900,000 تومان/ماه
  - **Premium:** 1,500,000 تومان/ماه
- ویژگی‌های هر پلن به‌صورت واضح لیست شده است
- تفاوت‌های پلن‌ها به‌صورت جدول مقایسه‌ای نمایش داده می‌شود
- پلن پیشنهادی (Standard) هایلایت شده است

### سناریو 2: مقایسه پلن‌ها
**Given:** کاربر در صفحه انتخاب پلن است  
**When:** دکمه "مقایسه پلن‌ها" را کلیک می‌کند  
**Then:**
- جدول مقایسه کامل نمایش داده می‌شود شامل:
  - تعداد محصولات قابل افزودن
  - تعداد سفارش ماهانه
  - رزرو میز (دارد/ندارد)
  - وب‌سایت اختصاصی
  - تعداد قالب‌های قابل استفاده
  - گزارش‌گیری پیشرفته
  - پشتیبانی (تلفنی/تیکت)
  - کمیسیون سفارش‌ها

### سناریو 3: انتخاب پلن ماهانه و پرداخت
**Given:** کاربر پلن Standard را انتخاب کرده است  
**When:** دکمه "خرید ماهانه - 900,000 تومان" را کلیک می‌کند  
**Then:**
- صفحه خلاصه سفارش نمایش داده می‌شود
- مبلغ قابل پرداخت (با احتساب مالیات) نمایش داده می‌شود
- فیلد "کد تخفیف" موجود است
- دکمه "پرداخت آنلاین" فعال است
- با کلیک بر روی پرداخت، کاربر به درگاه زرین‌پال منتقل می‌شود

### سناریو 4: انتخاب پلن سالانه با تخفیف
**Given:** کاربر پلن Premium را انتخاب کرده است  
**When:** گزینه "خرید سالانه (20% تخفیف)" را انتخاب می‌کند  
**Then:**
- قیمت اصلی: 18,000,000 تومان
- تخفیف سالانه: 3,600,000 تومان (20%)
- قیمت نهایی: 14,400,000 تومان
- پیام تبریک: "شما 3,600,000 تومان صرفه‌جویی کردید!"

### سناریو 5: اعمال کد تخفیف
**Given:** کاربر در صفحه خلاصه سفارش است  
**When:** کد تخفیف معتبر "OPENING2025" را وارد می‌کند  
**Then:**
- کد تخفیف اعمال می‌شود
- مبلغ تخفیف از کل مبلغ کسر می‌شود
- پیام موفقیت: "کد تخفیف با موفقیت اعمال شد - 10% تخفیف"
- قیمت نهایی به‌روز می‌شود

### سناریو 6: پرداخت موفق
**Given:** کاربر در درگاه زرین‌پال پرداخت را انجام داده است  
**When:** پرداخت با موفقیت تایید می‌شود  
**Then:**
- کاربر به صفحه "پرداخت موفق" هدایت می‌شود
- اشتراک کاربر فعال می‌شود
- فاکتور دیجیتال قابل دانلود است
- پیامک تایید خرید ارسال می‌شود
- ایمیل حاوی جزئیات اشتراک ارسال می‌شود
- کاربر به داشبورد هدایت می‌شود

### سناریو 7: پرداخت ناموفق
**Given:** کاربر در درگاه زرین‌پال است  
**When:** پرداخت با خطا مواجه می‌شود (موجودی ناکافی، کنسل توسط کاربر)  
**Then:**
- کاربر به صفحه "پرداخت ناموفق" هدایت می‌شود
- دلیل خطا نمایش داده می‌شود
- دکمه "تلاش مجدد" فعال است
- اشتراک فعال نمی‌شود

### سناریو 8: دوره آزمایشی (Trial)
**Given:** کاربر برای اولین بار ثبت‌نام کرده است  
**When:** گزینه "استفاده از دوره آزمایشی 7 روزه" را انتخاب می‌کند  
**Then:**
- بدون نیاز به پرداخت، اشتراک Basic برای 7 روز فعال می‌شود
- پیام هشدار: "دوره آزمایشی شما [X] روز دیگر پایان می‌یابد"
- در پایان دوره، کاربر برای خرید اشتراک هدایت می‌شود

---

## جزئیات فنی

### پلن‌های اشتراک:

#### Basic (پایه):
- **قیمت:** 500,000 تومان/ماه | 5,000,000 تومان/سال
- **محدودیت‌ها:**
  - تا 50 محصول
  - تا 100 سفارش/ماه
  - رزرو میز: ❌
  - 1 قالب وب‌سایت
  - گزارش‌گیری ساده
  - پشتیبانی تیکتی
  - کمیسیون: 3% هر سفارش

#### Standard (استاندارد):
- **قیمت:** 900,000 تومان/ماه | 9,000,000 تومان/سال
- **محدودیت‌ها:**
  - تا 200 محصول
  - تا 500 سفارش/ماه
  - رزرو میز: ✅
  - 3 قالب وب‌سایت
  - گزارش‌گیری پیشرفته
  - پشتیبانی تیکتی و تلفنی
  - کمیسیون: 2% هر سفارش

#### Premium (حرفه‌ای):
- **قیمت:** 1,500,000 تومان/ماه | 15,000,000 تومان/سال
- **محدودیت‌ها:**
  - محصولات نامحدود
  - سفارش‌های نامحدود
  - رزرو میز: ✅
  - تمام قالب‌های وب‌سایت
  - گزارش‌گیری و تحلیل پیشرفته
  - پشتیبانی اختصاصی 24/7
  - کمیسیون: 1% هر سفارش
  - مشاوره رایگان

### API Endpoints:

#### دریافت پلن‌ها:
```
GET /api/subscriptions/plans
Response (200):
{
  "success": true,
  "data": [
    {
      "id": "guid",
      "name": "Basic",
      "monthlyPrice": 500000,
      "yearlyPrice": 5000000,
      "features": [...],
      "limitations": {...}
    },
    ...
  ]
}
```

#### ایجاد سفارش اشتراک:
```
POST /api/subscriptions/orders
Content-Type: application/json

Request Body:
{
  "planId": "guid",
  "billingCycle": "monthly|yearly",
  "couponCode": "string" (optional)
}

Response (200):
{
  "success": true,
  "data": {
    "orderId": "guid",
    "amount": 900000,
    "discountAmount": 90000,
    "finalAmount": 810000,
    "tax": 81000,
    "totalAmount": 891000
  }
}
```

#### ایجاد تراکنش پرداخت:
```
POST /api/payments/initiate
Content-Type: application/json

Request Body:
{
  "orderId": "guid"
}

Response (200):
{
  "success": true,
  "data": {
    "paymentUrl": "https://zarinpal.com/...",
    "authority": "string"
  }
}
```

#### تایید پرداخت (Callback):
```
GET /api/payments/verify?authority={authority}&status={status}

Response: Redirect to success/failure page
```

---

## رفتار UI/UX

### صفحه انتخاب پلن:
- **Layout:** 3 کارت به‌صورت افقی (موبایل: عمودی)
- **پلن پیشنهادی:** Badge "پیشنهاد ویژه" + رنگ برجسته
- **دکمه‌ها:** واضح و متمایز
- **Toggle:** سوئیچ بین ماهانه/سالانه
- **Tooltip:** توضیحات اضافی برای ویژگی‌ها

### صفحه خلاصه سفارش:
- نمایش جزئیات پلن انتخابی
- شکست قیمت (Price Breakdown)
- فرم کد تخفیف
- دکمه پرداخت برجسته

### صفحه موفقیت:
- آیکون تیک سبز
- پیام تبریک
- جزئیات اشتراک
- دانلود فاکتور
- دکمه "ورود به پنل"

---

## وابستگی‌ها
- درگاه پرداخت زرین‌پال
- سرویس پیامک کاوه‌نگار
- سیستم ایمیل (SMTP)

---

## ملاحظات امنیتی
- اعتبارسنجی کد تخفیف در سمت سرور
- جلوگیری از تغییر قیمت در سمت کاربر
- لاگ تمام تراکنش‌ها
- Idempotency برای جلوگیری از پرداخت مکرر
- تایید امضای Webhook زرین‌پال

---

## تست‌ها
- [ ] تست نمایش پلن‌ها
- [ ] تست انتخاب پلن ماهانه
- [ ] تست انتخاب پلن سالانه
- [ ] تست اعمال کد تخفیف معتبر
- [ ] تست کد تخفیف نامعتبر
- [ ] تست پرداخت موفق
- [ ] تست پرداخت ناموفق
- [ ] تست دوره آزمایشی
- [ ] تست یکپارچگی با زرین‌پال
- [ ] تست ارسال پیامک و ایمیل

---

**تاریخ ایجاد:** 2025-10-02  
**آخرین بروزرسانی:** 2025-10-02  
**وضعیت:** ⬜ در انتظار توسعه
