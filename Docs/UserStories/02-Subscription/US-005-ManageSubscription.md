# User Story 05: مدیریت اشتراک

## شناسه: US-005
**اولویت:** متوسط  
**فاز:** MVP  
**تخمین زمان:** 2 روز

---

## شرح User Story

**به عنوان یک** مدیر رستوران  
**می‌خواهم** اشتراک فعلی خود را مدیریت، تمدید یا ارتقاء دهم  
**تا بتوانم** بر اساس نیازهای کسب‌وکارم از خدمات مناسب استفاده کنم.

---

## معیارهای پذیرش (Acceptance Criteria)

### سناریو 1: مشاهده وضعیت اشتراک
**Given:** کاربر در پنل مدیریتی است  
**When:** به بخش "مدیریت اشتراک" می‌رود  
**Then:**
- اطلاعات اشتراک فعلی نمایش داده می‌شود:
  - نام پلن: Standard
  - تاریخ شروع: 1402/07/10
  - تاریخ پایان: 1402/08/10
  - روزهای باقی‌مانده: 15 روز
  - وضعیت: فعال
- محدودیت‌های استفاده نمایش داده می‌شود:
  - تعداد محصولات: 45/200
  - تعداد سفارش‌های ماه جاری: 78/500
- تاریخچه پرداخت‌ها قابل مشاهده است

### سناریو 2: ارتقاء پلن
**Given:** کاربر پلن Basic دارد  
**When:** دکمه "ارتقاء پلن" را کلیک می‌کند  
**Then:**
- پلن‌های بالاتر (Standard, Premium) نمایش داده می‌شود
- محاسبه نسبتی (Prorated) برای باقی‌مانده دوره فعلی
- مثال: 15 روز از پلن Basic باقی مانده، کاربر فقط تفاوت را پرداخت می‌کند
- پس از پرداخت، پلن فوراً ارتقاء می‌یابد

### سناریو 3: تمدید اشتراک
**Given:** اشتراک کاربر 3 روز دیگر پایان می‌یابد  
**When:** کاربر به پنل وارد می‌شود  
**Then:**
- اعلان هشدار نمایش داده می‌شود: "اشتراک شما 3 روز دیگر پایان می‌یابد"
- دکمه "تمدید اشتراک" برجسته نمایش داده می‌شود
- با کلیک روی تمدید، صفحه پرداخت باز می‌شود
- پس از پرداخت موفق، تاریخ پایان به‌روز می‌شود

### سناریو 4: تمدید خودکار
**Given:** کاربر در بخش تنظیمات اشتراک است  
**When:** گزینه "تمدید خودکار" را فعال می‌کند  
**Then:**
- تنظیمات ذخیره می‌شود
- 3 روز قبل از پایان اشتراک، پیامک یادآوری ارسال می‌شود
- در تاریخ پایان، پرداخت به‌صورت خودکار از کارت ذخیره شده کسر می‌شود
- در صورت موفقیت، اشتراک تمدید می‌شود
- در صورت خطا، پیامک هشدار ارسال می‌شود

### سناریو 5: تنزل پلن
**Given:** کاربر پلن Premium دارد  
**When:** درخواست تغییر به پلن Standard می‌دهد  
**Then:**
- هشدار نمایش داده می‌شود: "با تنزل پلن، برخی ویژگی‌ها در دسترس نخواهد بود"
- لیست محدودیت‌های جدید نمایش داده می‌شود
- تغییر در پایان دوره فعلی اعمال می‌شود
- مبلغ اضافی بازگردانده نمی‌شود، اما در دوره بعد محاسبه می‌شود

### سناریو 6: لغو اشتراک
**Given:** کاربر تصمیم به لغو اشتراک گرفته است  
**When:** درخواست لغو اشتراک می‌دهد  
**Then:**
- فرم نظرسنجی دلیل لغو نمایش داده می‌شود
- هشدار: "اشتراک شما تا پایان دوره فعلی ([تاریخ]) فعال خواهد بود"
- پس از تایید، تمدید خودکار غیرفعال می‌شود
- در پایان دوره، اشتراک منقضی می‌شود

### سناریو 7: اشتراک منقضی شده
**Given:** اشتراک کاربر پایان یافته و تمدید نشده است  
**When:** کاربر به پنل وارد می‌شود  
**Then:**
- صفحه "اشتراک منقضی" نمایش داده می‌شود
- پیام: "اشتراک شما به پایان رسیده است. برای ادامه، لطفاً اشتراک خود را تمدید کنید"
- دکمه "تمدید اشتراک" برجسته
- دسترسی فقط به مشاهده اطلاعات (Read-only)
- امکان ثبت سفارش جدید وجود ندارد

---

## جزئیات فنی

### API Endpoints:

#### دریافت اطلاعات اشتراک:
```
GET /api/subscriptions/current

Response (200):
{
  "success": true,
  "data": {
    "planId": "guid",
    "planName": "Standard",
    "status": "active|expiring|expired",
    "startDate": "2025-10-01",
    "endDate": "2025-11-01",
    "daysRemaining": 15,
    "autoRenew": true,
    "usage": {
      "products": 45,
      "maxProducts": 200,
      "orders": 78,
      "maxOrders": 500
    }
  }
}
```

#### ارتقاء پلن:
```
POST /api/subscriptions/upgrade
Content-Type: application/json

Request Body:
{
  "newPlanId": "guid"
}

Response (200):
{
  "success": true,
  "data": {
    "proratedAmount": 300000,
    "orderId": "guid",
    "message": "مبلغ نسبتی محاسبه شد"
  }
}
```

#### تمدید اشتراک:
```
POST /api/subscriptions/renew
Content-Type: application/json

Request Body:
{
  "billingCycle": "monthly|yearly"
}

Response (200):
{
  "success": true,
  "data": {
    "orderId": "guid",
    "amount": 900000
  }
}
```

#### تنظیم تمدید خودکار:
```
PUT /api/subscriptions/auto-renew
Content-Type: application/json

Request Body:
{
  "enabled": true,
  "paymentMethodId": "guid" (optional)
}

Response (200):
{
  "success": true,
  "message": "تمدید خودکار فعال شد"
}
```

#### لغو اشتراک:
```
POST /api/subscriptions/cancel
Content-Type: application/json

Request Body:
{
  "reason": "string",
  "feedback": "string"
}

Response (200):
{
  "success": true,
  "message": "اشتراک شما در تاریخ [تاریخ] لغو خواهد شد"
}
```

---

## رفتار UI/UX

### صفحه مدیریت اشتراک:
- **کارت اشتراک فعلی:**
  - نام پلن با آیکون
  - تاریخ انقضا با Progress Bar
  - دکمه‌های "ارتقاء" و "تمدید"
  
- **بخش استفاده:**
  - نمودار میله‌ای برای محصولات
  - نمودار میله‌ای برای سفارش‌ها
  - درصد استفاده
  
- **تاریخچه پرداخت‌ها:**
  - جدول پرداخت‌ها با فیلتر
  - دانلود فاکتور
  - وضعیت (موفق/ناموفق)

### اعلان‌های هشدار:
- **30 روز قبل:** پیامک یادآوری
- **7 روز قبل:** اعلان در پنل + پیامک
- **3 روز قبل:** اعلان برجسته در پنل + پیامک
- **روز انقضا:** هشدار قرمز + محدود کردن دسترسی‌ها

---

## وابستگی‌ها
- سیستم پرداخت
- سرویس پیامک
- Scheduler برای بررسی خودکار انقضای اشتراک‌ها

---

## قوانین کسب‌وکار

### محاسبه نسبتی (Proration):
```
روزهای باقی‌مانده = تاریخ پایان - تاریخ فعلی
قیمت روزانه پلن قبلی = قیمت ماهانه / 30
قیمت روزانه پلن جدید = قیمت ماهانه / 30
مبلغ بازگشتی = روزهای باقی‌مانده × قیمت روزانه پلن قبلی
مبلغ پلن جدید = روزهای باقی‌مانده × قیمت روزانه پلن جدید
مبلغ قابل پرداخت = مبلغ پلن جدید - مبلغ بازگشتی
```

### دوره Grace Period:
- 3 روز پس از انقضا: دسترسی فقط خواندنی
- 7 روز پس از انقضا: غیرفعال کامل
- 30 روز پس از انقضا: حذف داده‌ها (با اعلان قبلی)

---

## تست‌ها
- [ ] تست مشاهده وضعیت اشتراک
- [ ] تست ارتقاء پلن
- [ ] تست محاسبه نسبتی
- [ ] تست تمدید دستی
- [ ] تست تمدید خودکار
- [ ] تست تنزل پلن
- [ ] تست لغو اشتراک
- [ ] تست اشتراک منقضی
- [ ] تست اعلان‌های هشدار
- [ ] تست محدودیت دسترسی

---

**تاریخ ایجاد:** 2025-10-02  
**آخرین بروزرسانی:** 2025-10-02  
**وضعیت:** ⬜ در انتظار توسعه
