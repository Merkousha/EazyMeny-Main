# User Story 15: سیستم اعلان‌ها و پیامک

## شناسه: US-015
**اولویت:** بالا | **فاز:** MVP | **تخمین:** 3 روز

---

## شرح User Story

**به عنوان یک** مدیر رستوران یا مشتری  
**می‌خواهم** اعلان‌های به‌موقع دریافت کنم  
**تا بتوانم** از وضعیت سفارش‌ها و رویدادها مطلع شوم.

---

## معیارهای پذیرش

### سناریو 1: پیامک‌های احراز هویت
**ثبت‌نام:**
```
کد تایید: 123456
EazyMenu
```

**بازیابی رمز:**
```
کد بازیابی رمز عبور: 654321
اعتبار: 10 دقیقه
EazyMenu
```

### سناریو 2: پیامک‌های سفارش - مشتری
**تایید سفارش:**
```
سفارش شما با موفقیت ثبت شد.
کد پیگیری: EZ-12345
زمان تقریبی: 30 دقیقه
پیگیری: eazymenu.ir/track/12345
```

**آماده شدن سفارش:**
```
سفارش شما آماده است!
کد: EZ-12345
لطفاً برای دریافت به رستوران مراجعه فرمایید.
```

### سناریو 3: پیامک‌های رزرو
**تایید رزرو:**
```
رزرو شما تایید شد.
تاریخ: 1402/07/15 ساعت 20:00
تعداد: 4 نفر
کد رزرو: RES-12345
لغو: eazymenu.ir/cancel/12345
```

**یادآوری:**
```
یادآوری: رزرو شما امشب ساعت 20:00
رستوران گلستان
در صورت لغو تا 2 ساعت قبل پیام دهید.
```

### سناریو 4: پیامک‌های مدیریتی - رستوران
**سفارش جدید:**
```
⚠️ سفارش جدید!
کد: EZ-12345
مبلغ: 250,000 تومان
برای مشاهده به پنل مراجعه کنید.
```

**هشدار انقضای اشتراک:**
```
⚠️ توجه
اشتراک شما 3 روز دیگر پایان می‌یابد.
برای تمدید: eazymenu.ir/renew
```

### سناریو 5: اعلان‌های داخل پنل
**Real-time Notifications:**
- سفارش جدید → Badge قرمز
- رزرو جدید → Badge آبی
- پیام ادمین → Badge زرد
- انقضای اشتراک → هشدار برجسته

**تاریخچه اعلان‌ها:**
- لیست تمام اعلان‌ها
- خوانده شده/خوانده نشده
- حذف اعلان
- حذف همه

### سناریو 6: مدیریت قالب پیامک
**پنل ادمین:**
- لیست قالب‌های پیامک
- ویرایش متن پیامک
- متغیرهای داینامیک:
  - `{customerName}`
  - `{orderCode}`
  - `{amount}`
  - `{restaurantName}`
  - `{date}`
  - `{time}`
- پیش‌نمایش پیامک
- تست ارسال

---

## API Endpoints

```
POST /api/notifications/sms/send
GET /api/notifications
PUT /api/notifications/{id}/mark-read
GET /api/admin/sms-templates
PUT /api/admin/sms-templates/{id}
```

---

## یکپارچگی با کاوه‌نگار

```csharp
public interface ISmsService
{
    Task SendAsync(string phoneNumber, string message);
    Task SendOtpAsync(string phoneNumber, string token);
    Task SendByTemplateAsync(string phoneNumber, string template, Dictionary<string, string> parameters);
}
```

### تنظیمات:
- API Key
- Sender Number
- قالب‌های از پیش تعریف شده

---

## صف پیامک (Queue)

- استفاده از **Hangfire** برای صف
- Retry: 3 بار با فاصله 5 دقیقه
- لاگ تمام پیامک‌های ارسالی
- گزارش پیامک‌های ناموفق

---

## تست‌ها
- [x] ارسال پیامک ثبت‌نام
- [x] ارسال پیامک سفارش
- [x] ارسال پیامک رزرو
- [x] اعلان Real-time
- [x] مدیریت قالب‌ها
- [x] صف و Retry

---

**وضعیت:** ⬜ در انتظار
