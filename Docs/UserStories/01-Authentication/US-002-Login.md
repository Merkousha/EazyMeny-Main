# User Story 02: ورود رستوران

## شناسه: US-002
**اولویت:** بالا  
**فاز:** MVP  
**تخمین زمان:** 2 روز

---

## شرح User Story

**به عنوان یک** مدیر رستوران  
**می‌خواهم** با شماره موبایل و رمز عبور به پنل مدیریتی خود وارد شوم  
**تا بتوانم** رستوران خود را مدیریت کنم و به امکانات پلتفرم دسترسی داشته باشم.

---

## معیارهای پذیرش (Acceptance Criteria)

### سناریو 1: ورود موفق با رمز عبور
**Given:** کاربر حساب کاربری فعال دارد  
**When:** شماره موبایل و رمز عبور صحیح را وارد می‌کند  
**Then:**
- کاربر به داشبورد پنل مدیریتی هدایت می‌شود
- پیام خوش‌آمدگویی نمایش داده می‌شود: "خوش آمدید، [نام رستوران]"
- Session کاربر ایجاد می‌شود

### سناریو 2: ورود با کد یکبار مصرف (OTP)
**Given:** کاربر در صفحه ورود است  
**When:** گزینه "ورود با کد یکبار مصرف" را انتخاب می‌کند  
**And:** شماره موبایل را وارد می‌کند  
**Then:**
- کد 6 رقمی به شماره موبایل ارسال می‌شود
- صفحه تایید کد نمایش داده می‌شود
- پس از وارد کردن کد صحیح، کاربر وارد پنل می‌شود

### سناریو 3: اطلاعات ورود نادرست
**Given:** کاربر در صفحه ورود است  
**When:** شماره موبایل یا رمز عبور اشتباه وارد می‌کند  
**Then:**
- پیام خطا نمایش داده می‌شود: "شماره موبایل یا رمز عبور اشتباه است"
- تعداد تلاش‌های ناموفق ثبت می‌شود
- پس از 5 تلاش ناموفق، حساب به مدت 15 دقیقه قفل می‌شود

### سناریو 4: به خاطر سپردن کاربر
**Given:** کاربر در صفحه ورود است  
**When:** گزینه "مرا به خاطر بسپار" را فعال می‌کند  
**And:** با موفقیت وارد می‌شود  
**Then:**
- Session کاربر برای 30 روز معتبر می‌ماند
- در ورود بعدی نیازی به وارد کردن اطلاعات نیست

### سناریو 5: حساب قفل شده
**Given:** حساب کاربر به دلیل تلاش‌های ناموفق قفل شده است  
**When:** تلاش به ورود می‌کند  
**Then:**
- پیام خطا نمایش داده می‌شود: "حساب شما به مدت [زمان باقی‌مانده] قفل شده است"
- لینک "بازیابی رمز عبور" نمایش داده می‌شود

### سناریو 6: اشتراک منقضی شده
**Given:** کاربر با موفقیت وارد شده است  
**When:** اشتراک او منقضی شده باشد  
**Then:**
- به صفحه تمدید اشتراک هدایت می‌شود
- پیام هشدار نمایش داده می‌شود: "اشتراک شما به پایان رسیده است. لطفاً برای ادامه استفاده، اشتراک خود را تمدید کنید"
- امکان مشاهده پلن‌ها و تمدید

---

## جزئیات فنی

### فرم ورود:
1. **شماره موبایل** (الزامی)
   - نوع: Tel
   - فرمت: 09XXXXXXXXX
   - Autocomplete: tel

2. **رمز عبور** (الزامی)
   - نوع: Password
   - نمایش/مخفی کردن رمز
   - Autocomplete: current-password

3. **مرا به خاطر بسپار** (اختیاری)
   - نوع: Checkbox
   - پیش‌فرض: غیرفعال

### API Endpoint:

#### ورود با رمز عبور:
```
POST /api/auth/login
Content-Type: application/json

Request Body:
{
  "phoneNumber": "string",
  "password": "string",
  "rememberMe": boolean
}

Response (Success - 200):
{
  "success": true,
  "message": "ورود موفقیت‌آمیز بود",
  "data": {
    "token": "jwt-token",
    "refreshToken": "refresh-token",
    "user": {
      "id": "guid",
      "restaurantName": "string",
      "managerName": "string",
      "subscriptionStatus": "active|expired|trial"
    }
  }
}

Response (Error - 401):
{
  "success": false,
  "message": "شماره موبایل یا رمز عبور اشتباه است",
  "remainingAttempts": 3
}

Response (Error - 423 - Locked):
{
  "success": false,
  "message": "حساب شما به مدت 15 دقیقه قفل شده است",
  "lockedUntil": "datetime"
}
```

#### ورود با OTP:
```
POST /api/auth/login/otp/request
Content-Type: application/json

Request Body:
{
  "phoneNumber": "string"
}

Response (Success - 200):
{
  "success": true,
  "message": "کد تایید ارسال شد",
  "expiresAt": "datetime"
}

---

POST /api/auth/login/otp/verify
Content-Type: application/json

Request Body:
{
  "phoneNumber": "string",
  "code": "string"
}

Response (Success - 200):
{
  "success": true,
  "message": "ورود موفقیت‌آمیز بود",
  "data": {
    "token": "jwt-token",
    ...
  }
}
```

---

## رفتار UI/UX

### طراحی صفحه:
- صفحه ورود ساده و تمیز
- لوگوی پلتفرم در بالای صفحه
- فرم مرکزی با Shadow
- دکمه‌های واضح
- لینک‌های کمکی (فراموشی رمز، ثبت‌نام)

### تجربه کاربری:
- Focus خودکار روی فیلد شماره موبایل
- نمایش/مخفی رمز عبور با آیکون چشم
- Loading indicator هنگام ارسال
- پیام‌های خطا زیر فرم
- انیمیشن ورود ملایم
- Redirect خودکار به داشبورد

### Responsive Design:
- Mobile: تمام صفحه
- Tablet: Card مرکزی
- Desktop: Card مرکزی با Background Image

---

## وابستگی‌ها
- ASP.NET Core Identity
- JWT Authentication
- سرویس پیامک کاوه‌نگار (برای OTP)
- Redis Cache (برای محدودیت تلاش)

---

## ملاحظات امنیتی
- Rate Limiting: حداکثر 5 تلاش در 15 دقیقه
- محدودیت IP برای تلاش‌های مشکوک
- لاگ تمام تلاش‌های ورود (موفق و ناموفق)
- انقضای Token: 24 ساعت (Access Token), 30 روز (Refresh Token)
- HTTPS اجباری
- CSRF Protection
- Secure Cookie (HttpOnly, Secure, SameSite)

---

## تست‌ها
- [ ] تست ورود موفق با رمز عبور
- [ ] تست ورود با اطلاعات نادرست
- [ ] تست ورود با OTP
- [ ] تست قفل شدن حساب
- [ ] تست "مرا به خاطر بسپار"
- [ ] تست اشتراک منقضی
- [ ] تست Rate Limiting
- [ ] تست عملکرد روی موبایل
- [ ] تست امنیتی

---

**تاریخ ایجاد:** 2025-10-02  
**آخرین بروزرسانی:** 2025-10-02  
**وضعیت:** ⬜ در انتظار توسعه
