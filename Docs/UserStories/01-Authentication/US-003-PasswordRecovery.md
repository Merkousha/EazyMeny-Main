# User Story 03: بازیابی رمز عبور

## شناسه: US-003
**اولویت:** متوسط  
**فاز:** MVP  
**تخمین زمان:** 1 روز

---

## شرح User Story

**به عنوان یک** مدیر رستوران  
**می‌خواهم** در صورت فراموشی رمز عبور، بتوانم آن را بازیابی کنم  
**تا بتوانم** مجدداً به حساب کاربری خود دسترسی پیدا کنم.

---

## معیارهای پذیرش (Acceptance Criteria)

### سناریو 1: درخواست بازیابی موفق
**Given:** کاربر در صفحه "فراموشی رمز عبور" است  
**When:** شماره موبایل معتبر خود را وارد می‌کند  
**Then:**
- کد بازیابی 6 رقمی به شماره موبایل ارسال می‌شود
- کاربر به صفحه تایید کد هدایت می‌شود
- پیام تایید نمایش داده می‌شود: "کد بازیابی به شماره موبایل شما ارسال شد"

### سناریو 2: تنظیم رمز عبور جدید
**Given:** کاربر کد بازیابی را وارد کرده است  
**When:** کد صحیح را تایید می‌کند  
**And:** رمز عبور جدید و تکرار آن را وارد می‌کند  
**Then:**
- رمز عبور با موفقیت تغییر می‌کند
- کاربر به صفحه ورود هدایت می‌شود
- پیام موفقیت نمایش داده می‌شود: "رمز عبور شما با موفقیت تغییر یافت"

### سناریو 3: شماره موبایل نامعتبر
**Given:** کاربر در صفحه "فراموشی رمز عبور" است  
**When:** شماره موبایلی که در سیستم ثبت نشده را وارد می‌کند  
**Then:**
- پیام خطا نمایش داده می‌شود: "شماره موبایل در سیستم یافت نشد"
- لینک "ثبت‌نام" برای کاربران جدید نمایش داده می‌شود

### سناریو 4: کد بازیابی نادرست
**Given:** کاربر در صفحه تایید کد است  
**When:** کد اشتباه را وارد می‌کند  
**Then:**
- پیام خطا نمایش داده می‌شود: "کد وارد شده صحیح نیست"
- تعداد تلاش‌های باقی‌مانده نمایش داده می‌شود
- پس از 3 تلاش ناموفق، باید کد جدید درخواست شود

### سناریو 5: انقضای کد بازیابی
**Given:** کد بازیابی ارسال شده است  
**When:** بیش از 10 دقیقه از ارسال می‌گذرد  
**Then:**
- کد منقضی می‌شود
- پیام خطا: "کد بازیابی منقضی شده است"
- دکمه "ارسال مجدد کد" فعال می‌شود

---

## جزئیات فنی

### مراحل فرآیند:
1. وارد کردن شماره موبایل
2. ارسال کد بازیابی
3. تایید کد بازیابی
4. وارد کردن رمز عبور جدید
5. تایید موفقیت

### API Endpoints:

#### درخواست بازیابی:
```
POST /api/auth/password/reset/request
Content-Type: application/json

Request Body:
{
  "phoneNumber": "string"
}

Response (Success - 200):
{
  "success": true,
  "message": "کد بازیابی ارسال شد",
  "expiresAt": "datetime"
}

Response (Error - 404):
{
  "success": false,
  "message": "شماره موبایل در سیستم یافت نشد"
}
```

#### تایید کد بازیابی:
```
POST /api/auth/password/reset/verify
Content-Type: application/json

Request Body:
{
  "phoneNumber": "string",
  "code": "string"
}

Response (Success - 200):
{
  "success": true,
  "message": "کد تایید شد",
  "resetToken": "temporary-token"
}

Response (Error - 400):
{
  "success": false,
  "message": "کد وارد شده صحیح نیست",
  "remainingAttempts": 2
}
```

#### تنظیم رمز جدید:
```
POST /api/auth/password/reset/confirm
Content-Type: application/json

Request Body:
{
  "resetToken": "string",
  "newPassword": "string"
}

Response (Success - 200):
{
  "success": true,
  "message": "رمز عبور با موفقیت تغییر یافت"
}
```

---

## رفتار UI/UX

### طراحی صفحه:
- صفحه ساده با توضیحات واضح
- Progress Indicator برای نمایش مرحله فعلی
- دکمه‌های بزرگ و واضح
- پیام‌های راهنما

### تجربه کاربری:
- توضیح مراحل در بالای صفحه
- Timer برای نمایش زمان انقضای کد
- دکمه "ارسال مجدد" با محدودیت زمانی (60 ثانیه)
- نمایش قدرت رمز عبور جدید
- Validation Real-time

### پیام‌های کمکی:
- "کد بازیابی به شماره موبایل شما ارسال شد"
- "کد را دریافت نکردید؟ 45 ثانیه تا ارسال مجدد"
- "رمز عبور باید حداقل 8 کاراکتر باشد"

---

## وابستگی‌ها
- سرویس پیامک کاوه‌نگار
- سیستم احراز هویت
- Redis Cache برای ذخیره کدهای موقت

---

## ملاحظات امنیتی
- محدودیت درخواست: حداکثر 3 درخواست در ساعت
- انقضای کد بازیابی: 10 دقیقه
- حداکثر تلاش برای وارد کردن کد: 3 بار
- Reset Token یکبار مصرف
- Hash کردن رمز عبور جدید
- لاگ تمام درخواست‌های بازیابی
- عدم افشای وجود/عدم وجود شماره موبایل (در صورت Security Enhancement)

---

## تست‌ها
- [ ] تست درخواست بازیابی موفق
- [ ] تست شماره موبایل نامعتبر
- [ ] تست تایید کد صحیح
- [ ] تست کد نادرست
- [ ] تست انقضای کد
- [ ] تست ارسال مجدد کد
- [ ] تست تنظیم رمز جدید
- [ ] تست محدودیت درخواست
- [ ] تست امنیتی

---

**تاریخ ایجاد:** 2025-10-02  
**آخرین بروزرسانی:** 2025-10-02  
**وضعیت:** ⬜ در انتظار توسعه
