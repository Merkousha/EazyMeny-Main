# 📅 Reservation System - User Guide

## 📖 راهنمای کامل سیستم رزرو میز

---

## 🎯 درباره سیستم

سیستم رزرو میز EazyMenu به رستوران‌ها اجازه می‌دهد تا رزروهای آنلاین دریافت کنند و مشتریان به راحتی میز رزرو کنند.

### ویژگی‌ها:
- ✅ رزرو آنلاین برای مشتریان
- ✅ مدیریت رزروها توسط رستوران
- ✅ ارسال SMS خودکار (تایید، لغو، یادآوری)
- ✅ تخصیص میز به رزروها
- ✅ فیلتر و جستجوی پیشرفته
- ✅ Timeline تاریخچه
- ✅ آمار و گزارش‌گیری

---

## 👥 نقش‌های کاربری

### 1. مشتری (Customer)
**دسترسی:**
- مشاهده فرم رزرو
- ثبت رزرو جدید
- مشاهده لیست رزروهای خود
- لغو رزرو

**محدودیت:**
- فقط رزروهای خودش را می‌بیند
- نمی‌تواند رزروهای دیگران را لغو کند

### 2. مالک رستوران (RestaurantOwner)
**دسترسی:**
- مشاهده تمام رزروهای رستوران
- تایید رزروها
- تخصیص میز
- لغو رزروها
- فیلتر و جستجو
- مشاهده آمار

**محدودیت:**
- فقط رزروهای رستوران خودش

### 3. ادمین (Admin)
**دسترسی:**
- مشاهده تمام رزروهای تمام رستوران‌ها (در صورت نیاز)
- مدیریت کامل سیستم

---

## 🔄 چرخه حیات رزرو (Reservation Lifecycle)

```
1️⃣ Pending (در انتظار تایید)
   ↓ [Restaurant confirms]
2️⃣ Confirmed (تایید شده)
   ↓ [Customer arrives OR doesn't show up OR cancels]
3️⃣ Completed (تکمیل شده) / NoShow (عدم حضور) / Cancelled (لغو شده)
```

### وضعیت‌های رزرو:

| Status | Persian | Color | Description |
|--------|---------|-------|-------------|
| Pending | در انتظار تایید | Warning (Yellow) | رزرو ثبت شده، منتظر تایید رستوران |
| Confirmed | تایید شده | Success (Green) | رستوران تایید کرده، میز تخصیص یافته |
| Completed | تکمیل شده | Primary (Blue) | مشتری حضور یافته و سفارش داده |
| Cancelled | لغو شده | Danger (Red) | توسط مشتری یا رستوران لغو شده |
| NoShow | عدم حضور | Secondary (Gray) | مشتری حضور پیدا نکرده |

---

## 📋 راهنمای مشتری

### ✅ چگونه رزرو کنیم؟

#### مرحله 1: ورود به صفحه رزرو
```
URL: /Reservation/Reserve?restaurantId={guid}
یا: /menu/{slug} → دکمه "رزرو میز"
```
- از منوی رستوران یا QR Code استفاده کنید
- فرم رزرو نمایش داده می‌شود

#### مرحله 2: تکمیل فرم
**اطلاعات شخصی:**
- نام و نام خانوادگی (الزامی)
- شماره تلفن: `09xxxxxxxxx` (الزامی، 11 رقم)
- ایمیل (اختیاری)

**جزئیات رزرو:**
- تاریخ: حداقل امروز (HTML5 date picker)
- ساعت: `HH:mm` فرمت (مثال: 19:00)
- تعداد نفرات: 1 تا 20 نفر (dropdown)
- درخواست‌های ویژه: متن آزاد (اختیاری)
  - مثال: "میز کنار پنجره"، "کرسی بچه نیاز است"

#### مرحله 3: ثبت رزرو
- کلیک "ثبت رزرو"
- SMS تایید دریافت می‌کنید
- شماره رزرو نمایش داده می‌شود

#### مرحله 4: پیگیری
```
URL: /Reservation/MyReservations
```
- لیست رزروهای خود را مشاهده کنید
- وضعیت رزرو را بررسی کنید
- در صورت نیاز لغو کنید

---

### 📱 مشاهده رزروهای من

**نمای لیست:**
- جدول شامل: شماره رزرو، رستوران، تاریخ، ساعت، تعداد نفرات، میز، وضعیت
- دکمه‌های عملیات: جزئیات، لغو

**کارت‌های آمار:**
- در انتظار تایید (Warning)
- تایید شده (Success)
- تکمیل شده (Primary)
- لغو شده (Danger)

**عملیات:**
- **جزئیات:** مشاهده کامل رزرو
- **لغو رزرو:** فقط برای Pending/Confirmed و رزروهای آینده

---

### ❌ لغو رزرو

**شرایط:**
- وضعیت: Pending یا Confirmed
- تاریخ رزرو: آینده (نه گذشته)

**مراحل:**
1. کلیک "لغو رزرو"
2. Modal باز می‌شود
3. دلیل لغو را وارد کنید (اختیاری برای مشتری)
4. تایید لغو
5. SMS به رستوران ارسال می‌شود

**نکات:**
- رزروهای گذشته قابل لغو نیستند
- رزروهای لغو شده قابل بازگشت نیستند
- برای رزرو مجدد، فرم جدید پر کنید

---

## 🏪 راهنمای رستوران

### 📊 داشبورد رزروها

```
URL: /Restaurant/Reservation/Index/{slug}
مثال: /Restaurant/Reservation/Index/zeitoon
```

**آمار کوتاه (Small Boxes):**
- در انتظار تایید: تعداد رزروهای Pending
- تایید شده: تعداد رزروهای Confirmed
- تکمیل شده: تعداد رزروهای Completed
- لغو شده: تعداد رزروهای Cancelled

**فیلترها:**
- از تاریخ / تا تاریخ
- وضعیت: همه، Pending، Confirmed، Completed، Cancelled، NoShow
- دکمه جستجو و پاک کردن فیلتر

**جدول رزروها:**
- ستون‌ها: شماره رزرو، مشتری، تلفن، تاریخ، ساعت، تعداد نفرات، میز، وضعیت، عملیات
- عملیات: جزئیات، تایید (فقط Pending)، لغو

---

### ✅ تایید رزرو

**شرایط:**
- وضعیت: Pending
- تاریخ رزرو: آینده

**مراحل:**
1. کلیک "تایید" (دکمه سبز)
2. Modal تایید باز می‌شود
3. شماره میز را وارد کنید (اختیاری)
   - مثال: 5، 10، A2
4. کلیک "تایید رزرو"

**نتیجه:**
- وضعیت: Pending → Confirmed
- TableNumber ذخیره می‌شود
- SMS به مشتری: "رزرو شما تایید شد. میز شماره: {number}"
- دکمه "تایید" حذف می‌شود

**نکات:**
- اگر میز خاصی ندارید، خالی بگذارید
- بعد از تایید، فقط می‌توانید لغو کنید
- شماره میز بعداً قابل ویرایش است (در Details)

---

### 🚫 لغو رزرو

**شرایط:**
- وضعیت: Pending یا Confirmed
- تاریخ رزرو: آینده

**مراحل:**
1. کلیک "لغو" (دکمه قرمز)
2. Modal لغو باز می‌شود
3. دلیل لغو را وارد کنید (**الزامی**)
   - مثال: "رستوران تعطیل است"، "جا نداریم"
4. کلیک "لغو رزرو"

**نتیجه:**
- وضعیت: → Cancelled
- CancellationReason ذخیره می‌شود
- CancelledAt ثبت می‌شود
- SMS به مشتری با دلیل لغو

**نکات:**
- دلیل لغو برای مشتری نمایش داده می‌شود
- رزروی که لغو شد قابل بازگشت نیست
- از دلایل واضح استفاده کنید

---

### 🔍 جزئیات رزرو

```
URL: /Restaurant/Reservation/Details/{id}
```

**اطلاعات نمایش داده شده:**

**کارت اصلی:**
- شماره رزرو (بزرگ، آبی)
- Info Boxes (4): تاریخ، ساعت، تعداد نفرات، میز

**جدول مشتری:**
- نام، تلفن، ایمیل

**درخواست‌های ویژه:**
- متن کامل درخواست (در صورت وجود)

**دلیل لغو:**
- اگر لغو شده باشد، دلیل نمایش داده می‌شود

**Timeline (Sidebar):**
- ایجاد رزرو: تاریخ و ساعت
- تایید: اگر تایید شده
- لغو: اگر لغو شده با دلیل
- یادآوری: اگر SMS ارسال شده

**دکمه‌های عملیات:**
- بازگشت به لیست
- تایید رزرو (اگر Pending)
- لغو رزرو (اگر Pending/Confirmed)

---

### 📅 نمای تقویم (Calendar View)

```
URL: /Restaurant/Reservation/Calendar/{slug}
مثال: /Restaurant/Reservation/Calendar/zeitoon
```

**ویژگی‌ها:**
- انتخاب تاریخ با Date Picker در صفحه (نه در URL)
- دکمه‌های ناوبری: روز قبل، امروز، روز بعد
- نمایش رزروهای یک روز با AJAX
- مرتب‌سازی بر اساس ساعت
- آمار روزانه: کل رزروها، در انتظار، تایید شده، کل نفرات
- جدول با ستون‌های: ساعت، شماره رزرو، مشتری، تلفن، تعداد نفرات، میز، وضعیت، عملیات
- تایید سریع از همین صفحه

**استفاده:**
- برای برنامه‌ریزی روزانه
- چک‌کردن ظرفیت رستوران
- آماده‌سازی میزها

---

## 🔔 سیستم SMS

### پیام‌های خودکار:

#### 1️⃣ ایجاد رزرو (مشتری)
```
رزرو شما در رستوران {Name}
تاریخ: {Date}
ساعت: {Time}
تعداد نفرات: {Guests}
شماره رزرو: {Number}
منتظر تایید رستوران هستیم.
```

#### 2️⃣ تایید رزرو (مشتری)
```
رزرو شما در رستوران {Name} تایید شد.
تاریخ: {Date}
ساعت: {Time}
میز شماره: {Table}
منتظر دیدارتان هستیم!
```

#### 3️⃣ لغو توسط مشتری (رستوران)
```
رزرو شماره {Number} توسط مشتری لغو شد.
مشتری: {CustomerName}
تاریخ: {Date}
ساعت: {Time}
```

#### 4️⃣ لغو توسط رستوران (مشتری)
```
متاسفانه رزرو شما در رستوران {Name} لغو شد.
دلیل: {Reason}
تاریخ: {Date}
برای رزرو مجدد تماس بگیرید.
```

#### 5️⃣ یادآوری (1 روز قبل) - Future Feature
```
یادآوری: رزرو شما فردا
رستوران: {Name}
ساعت: {Time}
میز: {Table}
در صورت لغو، لطفاً اطلاع دهید.
```

---

## 🛠️ تنظیمات

### پیکربندی SMS (Kavenegar)

**appsettings.json:**
```json
{
  "SMS": {
    "Kavenegar": {
      "ApiKey": "your-api-key",
      "SenderNumber": "10004346",
      "BaseUrl": "https://api.kavenegar.com/v1/"
    }
  }
}
```

**Mock Mode (برای تست بدون SMS):**
```csharp
// در Infrastructure/DependencyInjection.cs
services.AddScoped<ISmsService, MockSmsService>();
```

---

### پیکربندی رستوران

**فعال‌سازی رزرو:**
```csharp
restaurant.AcceptReservations = true; // در Restaurant Entity
```

**غیرفعال‌سازی:**
```csharp
restaurant.AcceptReservations = false;
// فرم رزرو نمایش داده نمی‌شود
```

---

## 📊 گزارش‌گیری

### آمار روزانه:
```sql
SELECT 
    COUNT(*) AS TotalReservations,
    COUNT(CASE WHEN Status = 0 THEN 1 END) AS Pending,
    COUNT(CASE WHEN Status = 1 THEN 1 END) AS Confirmed,
    COUNT(CASE WHEN Status = 2 THEN 1 END) AS Completed,
    COUNT(CASE WHEN Status = 3 THEN 1 END) AS Cancelled,
    COUNT(CASE WHEN Status = 4 THEN 1 END) AS NoShow
FROM Reservations
WHERE RestaurantId = '{guid}'
  AND ReservationDate = CAST(GETDATE() AS DATE);
```

### میانگین تعداد نفرات:
```sql
SELECT AVG(GuestsCount) AS AvgGuests
FROM Reservations
WHERE RestaurantId = '{guid}'
  AND Status = 2 -- Completed
  AND ReservationDate >= DATEADD(MONTH, -1, GETDATE());
```

### نرخ حضور (Show-up Rate):
```sql
SELECT 
    (COUNT(CASE WHEN Status = 2 THEN 1 END) * 100.0) / 
    (COUNT(CASE WHEN Status IN (1,2,4) THEN 1 END)) AS ShowUpRate
FROM Reservations
WHERE RestaurantId = '{guid}'
  AND ReservationDate < GETDATE();
```

---

## 🐛 خطاهای رایج و حل آن‌ها

### 1. "شماره تلفن نامعتبر است"
**علت:** فرمت شماره اشتباه  
**حل:** از فرمت `09xxxxxxxxx` استفاده کنید (11 رقم، شروع با 09)

### 2. "تاریخ رزرو باید بعد از امروز باشد"
**علت:** انتخاب تاریخ گذشته  
**حل:** تاریخ امروز یا آینده انتخاب کنید

### 3. "رزرو یافت نشد"
**علت:** ID نامعتبر یا حذف شده  
**حل:** از لیست رزروها استفاده کنید

### 4. "شما اجازه دسترسی به این رزرو را ندارید"
**علت:** تلاش برای دیدن رزرو دیگران  
**حل:** فقط رزروهای خودتان را ببینید

### 5. "نمی‌توانید رزرو گذشته را لغو کنید"
**علت:** تلاش برای لغو رزرو گذشته  
**حل:** فقط رزروهای آینده قابل لغو هستند

---

## 🔐 امنیت

### دسترسی‌ها:
- **Public (مشتری):** Reserve، MyReservations، Details (فقط خودش)، Cancel (فقط خودش)
- **RestaurantOwner:** Index، Details، Confirm، Cancel (فقط رستوران خودش)
- **Admin:** Full access (در صورت نیاز)

### حفاظت:
- `[Authorize]` برای MyReservations
- `[Authorize(Roles = "RestaurantOwner")]` برای مدیریت رستوران
- Authorization checks در Handlers
- AntiForgeryToken در تمام POST forms

---

## 📞 پشتیبانی

**مشکل فنی:**
- بررسی Logs در Console
- چک کردن Database (Reservations table)
- تست SMS در Kavenegar Panel

**سوالات:**
- مستندات: `Docs/UserStories/US-011-Reservation.md`
- PRD: `Docs/PRD.MD` (بخش Reservation)
- Code: `src/EazyMenu.Application/Features/Reservations/`

---

## 📝 To-Do List (آینده)

- [ ] یادآوری خودکار (1 روز قبل) با Hangfire
- [ ] تقویم ماهانه (Calendar view)
- [ ] نمایش ظرفیت رستوران (Available slots)
- [ ] رزرو چندتایی (Bulk reservations)
- [ ] تاریخچه رزروهای مشتری
- [ ] نرخ‌دهی بعد از رزرو
- [ ] یکپارچگی با Google Calendar
- [ ] Export به Excel/PDF

---

**نسخه:** 1.0  
**تاریخ:** 4 اکتبر 2025  
**نویسنده:** EazyMenu Development Team  
**وضعیت:** ✅ Production Ready
